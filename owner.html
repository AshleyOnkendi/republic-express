<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Executive Dashboard | Republic Express</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- PREMIUM THEME VARIABLES --- */
        :root {
            --primary: #2c1a16;    /* Deep Coffee */
            --secondary: #c9a478;  /* Gold/Latte */
            --accent: #e63946;     /* Alert Red */
            --success: #2a9d8f;    /* Profit Green */
            --bg-body: #f4f6f8;    /* Dashboard Grey */
            --bg-card: #ffffff;
            --text-dark: #1f1f1f;
            --text-grey: #888888;
            --border: #e1e4e8;
            --radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --sidebar-width: 260px;
        }

        body.dark-mode {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-dark: #f4f4f4;
            --text-grey: #aaaaaa;
            --border: #333333;
        }
        
        * { box-sizing: border-box; outline: none; } 

        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-dark); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            transition: background 0.3s; 
        }

        /* --- SIDEBAR (Fixed & Pro) --- */
        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--bg-card); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 30px 20px; 
            z-index: 1000; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            flex-shrink: 0; /* Prevents squishing */
        }

        .brand { 
            font-size: 22px; 
            font-weight: 800; 
            color: var(--primary); 
            margin-bottom: 50px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 10px;
        }
        body.dark-mode .brand { color: var(--secondary); }

        .close-sidebar-btn { display: none; background: none; border: none; font-size: 24px; color: var(--text-dark); cursor: pointer; }

        .nav-item { 
            padding: 14px 20px; 
            margin-bottom: 8px; 
            border-radius: 12px; 
            cursor: pointer; 
            color: var(--text-grey); 
            font-weight: 500; 
            font-size: 15px;
            display: flex; align-items: center; gap: 12px;
            transition: all 0.2s;
            user-select: none; /* Make it feel like a button */
        }
        .nav-item:hover { background: rgba(0,0,0,0.03); color: var(--primary); }
        body.dark-mode .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }

        .nav-item.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 5px 15px rgba(44, 26, 22, 0.3);
        }
        body.dark-mode .nav-item.active { background: var(--secondary); color: var(--primary); }

        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border); padding-top: 20px; }

        /* --- MAIN CONTENT AREA --- */
        .main { 
            flex: 1; 
            padding: 30px 40px; 
            overflow-y: auto; 
            height: 100%; 
            position: relative; 
            scroll-behavior: smooth;
        }

        /* Section Visibility Logic */
        .section { 
            display: none; 
            animation: fadeIn 0.4s ease-out; 
        }
        .section.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            flex-wrap: wrap; 
            gap: 20px; 
        }

        .hamburger-btn { display: none; background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-dark); margin-right: 15px; }

        h1 { margin: 0; font-size: 28px; font-weight: 700; color: var(--text-dark); }
        .subtitle { margin: 0; color: var(--text-grey); font-size: 13px; font-weight: 500; }

        /* --- BUTTONS & FILTERS --- */
        .controls-row { display: flex; gap: 15px; align-items: center; }

        .filter-group { 
            background: var(--bg-card); 
            padding: 5px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            display: flex; 
            gap: 5px; 
        }
        .filter-btn { 
            padding: 8px 16px; 
            border: none; 
            background: none; 
            cursor: pointer; 
            border-radius: 8px; 
            font-weight: 600; 
            color: var(--text-grey); 
            font-size: 13px; 
            font-family: 'Poppins', sans-serif;
            transition: 0.2s;
        }
        .filter-btn.active { background: var(--primary); color: white; }
        body.dark-mode .filter-btn.active { background: var(--secondary); color: var(--primary); }

        .btn { 
            padding: 12px 24px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            background: var(--primary); 
            color: white; 
            font-family: 'Poppins', sans-serif;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.97); }

        /* --- CARDS & GRIDS --- */
        .card { 
            background: var(--bg-card); 
            border-radius: var(--radius); 
            padding: 25px; 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow); 
            margin-bottom: 25px;
            break-inside: avoid;
            page-break-inside: avoid; 
        }

        .grid-kpi { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 25px; 
            margin-bottom: 30px; 
        }
        
        .kpi-title { font-size: 12px; color: var(--text-grey); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        .kpi-value { font-size: 32px; font-weight: 700; color: var(--text-dark); margin-top: 10px; }

        .grid-charts { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
        .grid-ops { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        .chart-box { position: relative; height: 300px; width: 100%; margin-top: 15px; }

        /* --- TABLES & LISTS --- */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--text-grey); font-size: 12px; text-transform: uppercase; padding: 15px 10px; border-bottom: 1px solid var(--border); }
        td { padding: 15px 10px; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 500; }
        tr:last-child td { border-bottom: none; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-received { background: #fff3cd; color: #856404; }
        .badge-brewing { background: #d4edda; color: #155724; }
        .badge-ready { background: var(--secondary); color: white; }

        /* --- MENU MANAGER --- */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .menu-item-card { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            overflow: hidden; 
            position: relative; 
            break-inside: avoid; 
            transition: transform 0.2s;
        }
        .menu-item-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        
        .menu-img { width: 100%; height: 160px; object-fit: cover; }
        .stock-badge { 
            position: absolute; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.7); color: white; 
            padding: 4px 8px; border-radius: 6px; 
            font-size: 11px; font-weight: 700; backdrop-filter: blur(4px);
        }

        /* --- MODAL (Premium Form) --- */
        #editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { 
            background: var(--bg-card); 
            padding: 40px; 
            border-radius: 24px; 
            width: 500px; 
            max-width: 90%; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.25); 
        }
        
        input, select, textarea { 
            width: 100%; padding: 14px; 
            border: 2px solid var(--border); 
            background: var(--bg-body); 
            color: var(--text-dark); 
            border-radius: 12px; 
            margin-bottom: 15px; 
            font-family: inherit; font-size: 14px; font-weight: 500;
            transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--secondary); background: var(--bg-card); }
        
        label { font-size: 12px; font-weight: 700; color: var(--text-dark); margin-bottom: 5px; display: block; }

        .addon-group { border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 15px; background: var(--bg-body); }
        .sm-btn { padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; font-size: 12px; background: white; font-weight: 600; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 1024px) {
            .grid-charts, .grid-ops { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); box-shadow: 5px 0 30px rgba(0,0,0,0.2); }
            .sidebar.open { transform: translateX(0); }
            .hamburger-btn { display: block; } 
            .close-sidebar-btn { display: block; }
            .main { padding: 20px; }
            .grid-kpi { grid-template-columns: 1fr 1fr; }
        }
        
        @media (max-width: 480px) {
            .grid-kpi { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .controls-row { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar" data-html2canvas-ignore="true">
        <div class="brand">
            <span>‚òï Republic<span style="color:var(--secondary)">.</span></span>
            <button class="close-sidebar-btn" onclick="toggleSidebar()">√ó</button>
        </div>
        
        <div class="nav-item active" id="nav-dashboard" onclick="switchTab('dashboard')">
            <span>üìä</span> Analytics
        </div>
        <div class="nav-item" id="nav-menu" onclick="switchTab('menu')">
            <span>üçî</span> Menu Manager
        </div>
        <div class="nav-item" id="nav-feedback" onclick="switchTab('feedback')">
            <span>‚≠ê</span> Reviews
        </div>
        <div class="nav-item" id="nav-staff" onclick="switchTab('staff')">
            <span>üë•</span> Staff & Shifts
        </div>
        <div class="nav-item" id="nav-settings" onclick="switchTab('settings')">
            <span>‚öôÔ∏è</span> Settings
        </div>
        
        <div class="sidebar-footer">
            <div class="nav-item" onclick="toggleTheme()">
                <span id="theme-icon">üåô</span> <span id="theme-text">Switch Theme</span>
            </div>
            <div class="nav-item" onclick="logout()" style="color:var(--accent);">
                <span>üö™</span> Logout
            </div>
        </div>
    </div>

    <div class="main" id="report-area">
        
        <div id="dashboard" class="section active">
            <div class="page-header">
                <div class="header-title-group">
                    <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <div>
                        <h1>Executive Dashboard</h1>
                        <p class="subtitle" id="period-label">Overview for Today</p>
                    </div>
                </div>
                <div class="controls-row" data-html2canvas-ignore="true">
                    <div class="filter-group">
                        <button class="filter-btn active" onclick="setFilter('today', this)">Today</button>
                        <button class="filter-btn" onclick="setFilter('month', this)">Month</button>
                        <button class="filter-btn" onclick="setFilter('year', this)">Year</button>
                    </div>
                    <button class="btn" style="padding: 10px 16px; font-size:13px;" onclick="exportPDF()">üì• Report</button>
                </div>
            </div>

            <div class="grid-kpi">
                <div class="card">
                    <div class="kpi-title">Total Revenue</div>
                    <div class="kpi-value" style="color:var(--success)" id="kpi-revenue">...</div>
                </div>
                <div class="card">
                    <div class="kpi-title">Total Orders</div>
                    <div class="kpi-value" id="kpi-orders">...</div>
                </div>
                <div class="card">
                    <div class="kpi-title">Avg Rating</div>
                    <div class="kpi-value" style="color:var(--secondary)" id="kpi-rating">...</div>
                </div>
                <div class="card">
                    <div class="kpi-title">Stock Alert</div>
                    <div class="kpi-value" style="color:var(--accent)" id="kpi-stock">...</div>
                </div>
            </div>

            <div class="grid-charts">
                <div class="card">
                    <div class="kpi-title">Revenue Trend</div>
                    <div class="chart-box"><canvas id="revenueChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="kpi-title">Best Sellers</div>
                    <div class="chart-box"><canvas id="productChart"></canvas></div>
                </div>
            </div>

            <div class="grid-ops">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <span class="kpi-title" style="color:var(--accent);">üî• Live Orders</span>
                        <span id="active-count" style="background:var(--accent); color:white; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:bold;">0</span>
                    </div>
                    <div id="active-orders-list"></div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <span class="kpi-title" style="color:#2980b9;">üë• Staff On Duty</span>
                        <span id="staff-count" style="background:#2980b9; color:white; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:bold;">0</span>
                    </div>
                    <table style="width:100%"><tbody id="mini-staff-table"></tbody></table>
                </div>
            </div>
        </div>

        <div id="menu" class="section">
            <div class="page-header">
                <div class="header-title-group">
                      <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
                      <h1>Menu Manager</h1>
                </div>
                <button class="btn" onclick="openEditor()">+ Add New Item</button>
            </div>
            <div class="menu-grid" id="menu-grid"></div>
        </div>

        <div id="feedback" class="section">
            <div class="page-header">
                <div class="header-title-group">
                    <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <h1>Customer Feedback</h1>
                </div>
            </div>
            <div class="card">
                <div id="reviews-list">Loading reviews...</div>
            </div>
        </div>

        <div id="staff" class="section">
             <div class="page-header">
                 <div class="header-title-group">
                     <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
                     <h1>Staff Intelligence</h1>
                 </div>
             </div>
             
             <div class="grid-charts">
                 <div class="card">
                     <h3>Detailed Metrics</h3>
                     <table style="width:100%">
                         <thead><tr><th>Staff Name</th><th>Orders</th><th>Revenue</th><th>Avg Rating</th></tr></thead>
                         <tbody id="staff-analytics-table"><tr><td>Loading...</td></tr></tbody>
                     </table>
                 </div>
                 
                 <div class="card">
                     <h3>Manage Accounts</h3>
                     <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                         <input id="new-user" placeholder="Username" style="flex:1;">
                         <input id="new-pass" placeholder="Password" style="flex:1;">
                         <select id="new-role" style="flex:1;"><option value="barista">Barista</option><option value="owner">Owner</option></select>
                     </div>
                     <button class="btn" style="width:100%; margin-bottom:20px;" onclick="addStaff()">+ Add User</button>
                     <div style="max-height: 200px; overflow-y:auto;">
                        <table style="width:100%"><tbody id="full-staff-table"></tbody></table>
                     </div>
                 </div>
             </div>

             <div class="card" style="margin-top:20px;">
                 <h3>üèÜ Top Performers (Orders Handled)</h3>
                 <div class="chart-box"><canvas id="staffPerfChart"></canvas></div>
             </div>
        </div>

        <div id="settings" class="section">
             <div class="page-header"><div class="header-title-group"><button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button><h1>Settings</h1></div></div>
             <div class="card" style="max-width:500px;">
                 <h3>Update Security</h3>
                 <label>New Password</label>
                 <input type="password" id="update-pass" placeholder="Enter new password">
                 <button class="btn" onclick="updateMyPassword()">Update Password</button>
             </div>
        </div>

    </div>

    <div id="editor-modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-top:0; color:var(--primary);">Edit Item</h2>
            <input type="hidden" id="edit-id">
            
            <label>Item Name</label>
            <input type="text" id="edit-name" placeholder="e.g. Caramel Macchiato">
            
            <div style="display:flex; gap:15px;">
                <div style="flex:1"><label>Price (KES)</label><input type="number" id="edit-price"></div>
                <div style="flex:1"><label>Category</label><select id="edit-category"><option>Hot Coffee</option><option>Iced Coffee</option><option>Tea</option><option>Snacks</option><option>Meals</option></select></div>
            </div>
            
            <div style="display:flex; gap:15px;">
                <div style="flex:1"><label>Original Price (Optional)</label><input type="number" id="edit-original"></div>
                <div style="flex:1"><label>Stock</label><input type="number" id="edit-stock" placeholder="100"></div>
            </div>

            <label>Description</label>
            <textarea id="edit-desc" rows="2"></textarea>
            
            <label>Internal Inventory Note</label>
            <textarea id="inventory-note" rows="2" placeholder="e.g. 'Fresh batch arrived at 8am'"></textarea>

            <div style="margin-top:15px; border:2px dashed var(--border); padding:15px; border-radius:12px;">
                <label style="color:var(--primary);">Add-ons / Variants</label>
                <div id="addons-container"></div>
                <button class="sm-btn" style="width:100%; margin-top:10px;" onclick="addAddonGroup()">+ Add Option Group</button>
            </div>
            
            <label style="margin-top:20px;">Product Image</label>
            <input type="file" id="edit-image" accept="image/*">
            
            <div style="margin-top:30px; display:flex; gap:15px;">
                <button class="btn" onclick="saveItem()" style="flex:2;">Save Changes</button>
                <button class="btn" style="background:var(--bg-body); color:var(--text-dark); flex:1;" onclick="closeEditor()">Cancel</button>
            </div>
            <button class="btn" id="delete-btn" style="width:100%; margin-top:15px; background:var(--accent);" onclick="deleteItem()">Delete Item</button>
        </div>
    </div>

    <script>
        const PROJECT_URL = "https://uveudhkfncwbllczhbhf.supabase.co";
        const PROJECT_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2ZXVkaGtmbmN3YmxsY3poYmhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NTE5MTksImV4cCI6MjA4MjEyNzkxOX0.30rZbjVgShWxeI5FOD8zGJU-Ho6h6d5s7foEIlQVSZI";
        const db = supabase.createClient(PROJECT_URL, PROJECT_KEY);
        let allOrders = [], revenueChartInst = null, productChartInst = null, staffChartInst = null, currentFilter = 'today', currentAddons = [];
        
        const user = JSON.parse(localStorage.getItem('republic_user'));
        if (!user || user.role !== 'owner') window.location.href = 'login.html';
        
        // SAFE INIT: Prevents JS crash if DB fails
        try {
            init();
        } catch(e) { console.error("Init Error:", e); }

        function toggleSidebar(forceOpen) { const el = document.getElementById('sidebar'); if (forceOpen === false) el.classList.remove('open'); else el.classList.toggle('open'); }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); localStorage.setItem('owner_theme', isDark ? 'dark' : 'light'); document.getElementById('theme-icon').innerText = isDark ? "‚òÄÔ∏è" : "üåô"; if(document.getElementById('dashboard').classList.contains('active')) renderCharts(allOrders); }
        if (localStorage.getItem('owner_theme') === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-icon').innerText = "‚òÄÔ∏è"; }

        // --- NEW: ROBUST NAVIGATION LOGIC ---
        function switchTab(tabId) {
            // 1. Hide all sections
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            // 2. Show target section
            document.getElementById(tabId).classList.add('active');
            
            // 3. Update Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Find the button that called this and make it active
            const btn = document.getElementById(`nav-${tabId}`);
            if(btn) btn.classList.add('active');
            
            // 4. Close mobile sidebar
            toggleSidebar(false);
        }

        async function init() {
            // Load Orders
            const { data: paid } = await db.from('orders').select('*').eq('payment_status', 'paid').order('created_at', {ascending: true});
            if(paid) { allOrders = paid; setFilter('today', document.querySelector('.filter-btn.active')); }
            
            // Load Other Data
            loadActiveOrders(); 
            loadStaffList(); 
            loadMenuGrid(); 
            loadReviews(); 
            loadStockAlert(); 
            loadStaffAnalytics();
        }

        function setFilter(period, btn) { 
            currentFilter = period; 
            if(btn) { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } 
            const now = new Date(); 
            let filtered = []; 
            if (period === 'today') filtered = allOrders.filter(o => o.created_at.startsWith(now.toISOString().split('T')[0])); 
            else if (period === 'month') filtered = allOrders.filter(o => o.created_at.startsWith(now.toISOString().slice(0, 7))); 
            else if (period === 'year') filtered = allOrders.filter(o => o.created_at.startsWith(now.toISOString().slice(0, 4))); 
            else filtered = allOrders; 
            
            const label = period.charAt(0).toUpperCase() + period.slice(1);
            document.getElementById('period-label').innerText = `Overview for ${label}`; 
            updateDashboard(filtered); 
        }

        function updateDashboard(orders) {
            const revenue = orders.reduce((sum, o) => sum + o.total_price, 0);
            const count = orders.length;
            
            const revEl = document.getElementById('kpi-revenue'); if(revEl) revEl.innerText = "KES " + revenue.toLocaleString();
            const orderEl = document.getElementById('kpi-orders'); if(orderEl) orderEl.innerText = count;
            
            renderCharts(orders);
        }

        function renderCharts(orders) {
            const isDark = document.body.classList.contains('dark-mode'); 
            const textColor = isDark ? '#aaaaaa' : '#666666'; 
            const gridColor = isDark ? '#333333' : '#eeeeee';
            
            const dataMap = {};
            orders.forEach(o => { const key = currentFilter === 'today' ? new Date(o.created_at).getHours()+":00" : new Date(o.created_at).toLocaleDateString(); dataMap[key] = (dataMap[key] || 0) + o.total_price; });
            
            const ctx1 = document.getElementById('revenueChart').getContext('2d'); if(revenueChartInst) revenueChartInst.destroy(); 
            revenueChartInst = new Chart(ctx1, { type: 'line', data: { labels: Object.keys(dataMap), datasets: [{ label: 'Sales', data: Object.values(dataMap), borderColor: '#c9a478', backgroundColor: 'rgba(201, 164, 120, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive:true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:textColor}, grid:{color:gridColor}}, y:{ticks:{color:textColor}, grid:{color:gridColor}}} } });
            
            const prodMap = {}; orders.forEach(o => o.items.forEach(i => prodMap[i.name] = (prodMap[i.name]||0)+1)); const top = Object.entries(prodMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const ctx2 = document.getElementById('productChart').getContext('2d'); if(productChartInst) productChartInst.destroy(); 
            productChartInst = new Chart(ctx2, { type: 'doughnut', data: { labels: top.map(x=>x[0]), datasets: [{ data: top.map(x=>x[1]), backgroundColor: ['#2c1a16','#4a2c25','#7d4e43','#c9a478','#e6d2b5'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio: false, plugins:{legend:{position:'right', labels:{color:textColor, usePointStyle:true}}} } });
        }

        /* --- STAFF LOGIC --- */
        async function loadStaffList() { 
            const { data } = await db.from('users').select('*'); 
            const manageTable = document.getElementById('full-staff-table');
            if(manageTable) manageTable.innerHTML = data.map(u => `<tr><td>${u.username}</td><td><span class="status-badge" style="background:#eee;">${u.role}</span></td><td style="text-align:right;"><button class="sm-btn" style="color:var(--accent); border-color:var(--accent);" onclick="delStaff(${u.id})">Remove</button></td></tr>`).join('');
            
            const miniTable = document.getElementById('mini-staff-table');
            if(miniTable) miniTable.innerHTML = data.map(u => `<tr><td>${u.username}</td><td style="text-align:right;"><span class="status-badge" style="background:var(--bg-body);">${u.role}</span></td></tr>`).join('');
            
            const countEl = document.getElementById('staff-count'); if(countEl) countEl.innerText = data.length;
        }

        async function loadStaffAnalytics() {
            const { data: orders } = await db.from('orders').select('*').eq('payment_status', 'paid');
            const { data: reviews } = await db.from('reviews').select('*');
            if(!orders) return;

            const stats = {}; 
            orders.forEach(o => {
                const staff = o.handled_by || 'Unknown';
                if(!stats[staff]) stats[staff] = { orders: 0, revenue: 0, ratings: [] };
                stats[staff].orders += 1;
                stats[staff].revenue += o.total_price;
                const rev = reviews ? reviews.find(r => r.order_id === o.id) : null;
                if(rev) stats[staff].ratings.push(rev.rating);
            });

            const tbody = document.getElementById('staff-analytics-table');
            if(tbody) {
                tbody.innerHTML = "";
                const labels = []; const dataPoints = [];
                Object.keys(stats).forEach(name => {
                    const s = stats[name];
                    const avgRating = s.ratings.length > 0 ? (s.ratings.reduce((a,b)=>a+b,0)/s.ratings.length).toFixed(1) : '-';
                    tbody.innerHTML += `<tr><td><b>${name}</b></td><td>${s.orders}</td><td>KES ${s.revenue.toLocaleString()}</td><td>${avgRating} ‚≠ê</td></tr>`;
                    labels.push(name); dataPoints.push(s.orders);
                });

                const ctx = document.getElementById('staffPerfChart').getContext('2d');
                if(staffChartInst) staffChartInst.destroy();
                const isDark = document.body.classList.contains('dark-mode'); const textColor = isDark ? '#aaa' : '#666';
                staffChartInst = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Orders', data: dataPoints, backgroundColor: '#c9a478', borderRadius:4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor }, grid:{display:false} }, y: { ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });
            }
        }

        /* --- REVIEWS & STOCK --- */
        async function loadReviews() {
            const { data } = await db.from('reviews').select('*').order('created_at', {ascending: false});
            const list = document.getElementById('reviews-list');
            if(data && data.length > 0) {
                const avg = (data.reduce((sum, r) => sum + r.rating, 0) / data.length).toFixed(1);
                const rateEl = document.getElementById('kpi-rating'); if(rateEl) rateEl.innerText = `${avg} ‚≠ê`;
                if(list) {
                    list.innerHTML = "";
                    data.forEach(r => {
                        const stars = "‚òÖ".repeat(r.rating) + "‚òÜ".repeat(5-r.rating);
                        list.innerHTML += `<div class="review-item"><div style="display:flex; justify-content:space-between;"><span class="stars">${stars}</span><span style="font-size:12px; color:var(--text-grey);">${new Date(r.created_at).toLocaleDateString()}</span></div><div class="review-comment">"${r.comment || 'No comment'}"</div></div>`;
                    });
                }
            } else { 
                const rateEl = document.getElementById('kpi-rating'); if(rateEl) rateEl.innerText = "-"; 
                if(list) list.innerHTML = "<p style='color:var(--text-grey); font-style:italic;'>No reviews yet.</p>"; 
            }
        }

        async function loadStockAlert() {
            const { data } = await db.from('menu_items').select('*').lt('stock_quantity', 10);
            const stockEl = document.getElementById('kpi-stock');
            if(stockEl) stockEl.innerText = data ? data.length + " Alert" : "Good";
        }

        /* --- MENU EDITOR --- */
        async function loadMenuGrid() { 
            const { data } = await db.from('menu_items').select('*').order('id'); 
            const grid = document.getElementById('menu-grid'); 
            // NEW: Offline-friendly gray placeholder
            const OFFLINE_IMG = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=';

            if(grid) { 
                grid.innerHTML = ""; 
                data.forEach(item => { 
                    // Use the item's image, or the offline gray box if missing
                    const img = item.image_url || OFFLINE_IMG; 
                    
                    const stockBadge = item.stock_quantity < 5 
                        ? `<div class="stock-badge" style="background:var(--accent)">Low: ${item.stock_quantity}</div>` 
                        : `<div class="stock-badge">${item.stock_quantity} in stock</div>`; 

                    grid.innerHTML += `
                        <div class="menu-item-card">
                            ${stockBadge}
                            <img src="${img}" class="menu-img" onerror="this.src='${OFFLINE_IMG}'">
                            <div style="padding:15px;">
                                <b>${item.name}</b><br>
                                <span style="color:var(--secondary); font-weight:700;">KES ${item.price}</span>
                                <button style="width:100%; margin-top:10px; padding:8px; cursor:pointer; border:1px solid var(--border); background:var(--bg-body); border-radius:8px;" onclick='openEditor(${JSON.stringify(item)})'>Edit Details</button>
                            </div>
                        </div>`; 
                }); 
            } 
        }
        
        function renderAddonEditor() { 
            const container = document.getElementById('addons-container'); 
            container.innerHTML = ""; 
            currentAddons.forEach((group, gIndex) => { 
                const optionsHtml = group.options.map((opt, oIndex) => `<div class="addon-row"><input type="text" placeholder="Option Name" value="${opt.name}" onchange="updateOption(${gIndex}, ${oIndex}, 'name', this.value)" style="flex:2; margin:0;"><input type="number" placeholder="Price" value="${opt.price}" onchange="updateOption(${gIndex}, ${oIndex}, 'price', this.value)" style="flex:1; margin:0;"><button class="sm-btn" onclick="removeOption(${gIndex}, ${oIndex})">X</button></div>`).join(''); 
                container.innerHTML += `<div class="addon-group"><div style="display:flex; gap:10px; margin-bottom:10px;"><input type="text" value="${group.name}" placeholder="Group Name (e.g. Milk)" onchange="updateGroup(${gIndex}, this.value)" style="margin:0; font-weight:bold;"><button class="sm-btn" onclick="removeGroup(${gIndex})" style="color:red; border-color:red;">Delete Group</button></div>${optionsHtml}<button class="sm-btn" style="margin-top:5px; width:100%;" onclick="addOptionToGroup(${gIndex})">+ Add Option</button></div>`; 
            }); 
        }
        
        window.addAddonGroup = () => { currentAddons.push({ name: "", options: [] }); renderAddonEditor(); }; 
        window.removeGroup = (i) => { currentAddons.splice(i, 1); renderAddonEditor(); }; 
        window.updateGroup = (i, val) => { currentAddons[i].name = val; }; 
        window.addOptionToGroup = (i) => { currentAddons[i].options.push({ name: "", price: 0 }); renderAddonEditor(); }; 
        window.removeOption = (gI, oI) => { currentAddons[gI].options.splice(oI, 1); renderAddonEditor(); }; 
        window.updateOption = (gI, oI, field, val) => { currentAddons[gI].options[oI][field] = field==='price' ? Number(val) : val; };
        
        window.openEditor = (item = null) => { 
            document.getElementById('editor-modal').style.display = 'flex'; 
            if (item) { 
                document.getElementById('edit-id').value = item.id; 
                document.getElementById('edit-name').value = item.name; 
                document.getElementById('edit-price').value = item.price; 
                document.getElementById('edit-category').value = item.category; 
                document.getElementById('edit-original').value = item.original_price; 
                document.getElementById('edit-desc').value = item.description; 
                document.getElementById('edit-stock').value = item.stock_quantity; 
                if(document.getElementById('inventory-note')) document.getElementById('inventory-note').value = item.inventory_note || "";
                document.getElementById('delete-btn').style.display = 'block'; 
                currentAddons = item.addons || []; 
            } else { 
                document.getElementById('edit-id').value = ""; 
                document.getElementById('edit-name').value = ""; 
                document.getElementById('edit-price').value = ""; 
                document.getElementById('edit-stock').value = "100"; 
                if(document.getElementById('inventory-note')) document.getElementById('inventory-note').value = "";
                document.getElementById('delete-btn').style.display = 'none'; 
                currentAddons = []; 
            } 
            renderAddonEditor(); 
        };
        window.closeEditor = () => document.getElementById('editor-modal').style.display = 'none';
        
        window.saveItem = async () => { 
            const id = document.getElementById('edit-id').value; 
            const btn = document.querySelector('button[onclick="saveItem()"]');
            btn.innerText = "Saving..."; btn.disabled = true;

            // 1. Prepare data object carefully
            let updateData = { 
                name: document.getElementById('edit-name').value, 
                price: parseFloat(document.getElementById('edit-price').value) || 0, 
                category: document.getElementById('edit-category').value, 
                original_price: parseFloat(document.getElementById('edit-original').value) || 0, 
                description: document.getElementById('edit-desc').value, 
                stock_quantity: parseInt(document.getElementById('edit-stock').value) || 0, 
                addons: currentAddons, 
                is_available: true 
            }; 

            // Optional: Only include inventory_note if the column exists in your DB
            const noteEl = document.getElementById('inventory-note');
            if (noteEl && noteEl.value) {
                updateData.inventory_note = noteEl.value;
            }

            // 2. Handle Image Upload
            const fileInput = document.getElementById('edit-image'); 
            if (fileInput.files.length > 0) { 
                const fileName = `img_${Date.now()}`; 
                const { error: uploadError } = await db.storage.from('menu_photos').upload(fileName, fileInput.files[0]); 
                if (!uploadError) {
                    const { data: urlData } = db.storage.from('menu_photos').getPublicUrl(fileName); 
                    updateData.image_url = urlData.publicUrl; 
                }
            } 

            // 3. Execute Database Command
            let result;
            if (id) { 
                result = await db.from('menu_items').update(updateData).eq('id', id); 
            } else { 
                result = await db.from('menu_items').insert([updateData]); 
            } 

            // 4. Handle Result
            if (result.error) {
                console.error("Database Error Detail:", result.error);
                alert("Failed to save: " + result.error.message);
                btn.innerText = "Save Changes"; btn.disabled = false;
            } else {
                closeEditor(); 
                loadMenuGrid(); 
                loadStockAlert(); 
                btn.innerText = "Save Changes"; btn.disabled = false;
            }
        };
        window.deleteItem = async () => { if(confirm("Delete?")) { await db.from('menu_items').delete().eq('id', document.getElementById('edit-id').value); closeEditor(); loadMenuGrid(); } };
        
        async function loadActiveOrders() { 
            const { data } = await db.from('orders').select('*').neq('status', 'completed').order('created_at', {ascending: false}); 
            const list = document.getElementById('active-orders-list'); 
            if(list) { 
                list.innerHTML = data.map(o => `
                    <div style="padding:12px 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700; font-size:13px;">#${o.id} ‚Ä¢ ${new Date(o.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            <div style="font-size:11px; color:var(--text-grey);">${o.customer_phone || 'Walk-in'}</div>
                        </div>
                        <span class="status-badge badge-${o.status}">${o.status}</span>
                    </div>`).join(''); 
            } 
            const countEl = document.getElementById('active-count'); 
            if(countEl) countEl.innerText = data.length; 
        }
        
        async function addStaff() { const u=document.getElementById('new-user').value, p=document.getElementById('new-pass').value, r=document.getElementById('new-role').value; if(u&&p){ await db.from('users').insert([{username:u, password:p, role:r}]); loadStaffList(); } }
        async function delStaff(id) { if(confirm("Remove?")) { await db.from('users').delete().eq('id', id); loadStaffList(); } }
        async function updateMyPassword() { const p = document.getElementById('update-pass').value; if(p){ await db.from('users').update({password:p}).eq('id', user.id); alert("Updated"); logout(); } }
        
        // --- EXPORT PDF (FIXED CONFIG) ---
        function exportPDF() { 
            const element = document.querySelector('.section.active'); 
            const btn = document.querySelector('button[onclick="exportPDF()"]');
            btn.innerText = "‚è≥...";
            
            html2pdf().set({ 
                margin: 0.3, 
                filename: `Republic_Report_${new Date().toISOString().split('T')[0]}.pdf`, 
                image: {type:'jpeg',quality:0.98}, 
                html2canvas: {scale:2, useCORS:true}, 
                jsPDF: {unit:'in', format:'letter', orientation:'landscape'},
                pagebreak: { mode: 'avoid-all', avoid: '.card' }
            }).from(element).save().then(() => { btn.innerText = "üì• Report"; }); 
        }
        
        function logout() { localStorage.removeItem('republic_user'); window.location.href='login.html'; }
        
        db.channel('exec-dash').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => { init(); }).subscribe();
    </script>
</body>
</html>
