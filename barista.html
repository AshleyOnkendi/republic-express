<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barista POS | Republic Express</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- PREMIUM KITCHEN THEME --- */
        :root {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --accent-new: #f1c40f; /* Yellow for New Orders */
            --accent-brew: #2ecc71; /* Green for Brewing */
            --accent-ready: #ffffff; /* White for Ready */
            --border: #333333;
            --radius: 12px;
        }

        body.light-mode {
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --border: #e1e4e8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            padding: 20px; 
            transition: background 0.3s; 
        }

        /* --- HEADER --- */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding-bottom: 20px; 
            margin-bottom: 20px; 
            border-bottom: 2px solid var(--border); 
        }
        
        .brand h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--accent-new); letter-spacing: -0.5px; }
        .clock { color: var(--text-muted); font-size: 14px; font-weight: 600; margin-top: 4px; }

        .header-controls { display: flex; gap: 10px; }
        
        .btn-header { 
            background: var(--bg-card); 
            color: var(--text-main); 
            border: 1px solid var(--border); 
            padding: 12px 20px; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: 0.2s;
        }
        .btn-pos { background: var(--accent-brew); color: white; border: none; }
        .btn-header:active { transform: scale(0.96); }

        /* --- ORDERS GRID (MASONRY STYLE) --- */
        #orders-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
        }

        /* --- ORDER CARD --- */
        .order-card { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            padding: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
            position: relative; 
            border-top: 6px solid transparent; 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Status Colors */
        .status-received { border-top-color: var(--accent-new); }
        .status-brewing { border-top-color: var(--accent-brew); }
        .status-ready { border-top-color: var(--accent-ready); opacity: 0.8; }

        .card-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; border-bottom: 1px dashed var(--border); padding-bottom: 10px; 
        }
        .order-id { font-size: 18px; font-weight: 800; color: var(--text-main); }
        .order-time { font-size: 12px; background: var(--border); padding: 4px 8px; border-radius: 4px; }

        .order-items { margin-bottom: 20px; }
        .item-row { margin-bottom: 8px; font-size: 15px; }
        .item-qty { font-weight: 700; color: var(--accent-new); margin-right: 5px; }
        .item-details { display: block; font-size: 12px; color: var(--text-muted); margin-left: 20px; }

        .card-footer { display: flex; flex-direction: column; gap: 10px; }

        /* --- BUTTONS --- */
        .btn-action { 
            width: 100%; padding: 14px; 
            border: none; border-radius: 8px; 
            font-weight: 700; font-size: 14px; 
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.2s; 
        }
        
        .btn-brew { background: var(--accent-new); color: black; }
        .btn-ready { background: var(--accent-brew); color: white; }
        .btn-done { background: transparent; border: 2px solid var(--border); color: var(--text-muted); }
        .btn-pay { background: #e74c3c; color: white; animation: flash 2s infinite; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* --- STAFF SELECTOR --- */
        .staff-select { 
            width: 100%; padding: 10px; 
            background: var(--bg-body); color: var(--text-main); 
            border: 1px solid var(--border); border-radius: 6px; 
            margin-bottom: 10px; font-family: inherit; 
        }

        /* --- OVERLAYS --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 2000; display: none; 
            align-items: center; justify-content: center; 
        }
        
        .start-btn { 
            padding: 20px 40px; font-size: 20px; font-weight: 800; 
            background: var(--accent-new); color: black; 
            border: none; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.4); 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- POS MODAL (Tablet Style) --- */
        .pos-box { 
            background: var(--bg-card); 
            width: 900px; height: 90vh; max-width: 95%; 
            border-radius: 16px; padding: 25px; 
            display: flex; flex-direction: column; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); 
        }
        
        #pos-menu { 
            flex: 1; overflow-y: auto; 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 15px; margin-top: 20px; 
        }
        
        .pos-item { 
            background: var(--bg-body); border: 1px solid var(--border); 
            border-radius: 12px; cursor: pointer; 
            overflow: hidden; transition: 0.1s; 
        }
        .pos-item:active { transform: scale(0.95); border-color: var(--accent-new); }
        .pos-img { width: 100%; height: 100px; object-fit: cover; }
        .pos-info { padding: 10px; text-align: center; }
        
        /* ADDON MODAL */
        .addon-box { background: var(--bg-card); padding: 30px; border-radius: 16px; width: 400px; max-width: 90%; }
        .opt-btn { 
            padding: 10px 15px; margin: 5px; 
            border: 1px solid var(--border); background: transparent; 
            color: var(--text-main); border-radius: 8px; cursor: pointer; 
        }
        .opt-btn.selected { background: var(--accent-new); color: black; border-color: var(--accent-new); font-weight: 700; }

    </style>
</head>
<body>

    <audio id="audio-new-order"><source src="https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3" type="audio/mpeg"></audio>

    <div id="interaction-overlay" class="modal-overlay" style="display:flex;">
        <div style="text-align:center;">
            <h1 style="color:white; margin-bottom:10px;">‚òï Kitchen Display</h1>
            <p style="color:#aaa; margin-bottom:30px;">Tap to initialize audio & realtime connection</p>
            <button class="start-btn" onclick="startShift()">START SHIFT üîî</button>
        </div>
    </div>

    <div id="pos-modal" class="modal-overlay">
        <div class="pos-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">New Order</h2>
                <button onclick="closePOS()" style="background:none; border:none; color:var(--text-muted); font-size:28px; cursor:pointer;">√ó</button>
            </div>
            
            <div id="pos-menu">Loading Menu...</div>
            
            <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
                <div id="pos-cart-list" style="max-height: 100px; overflow-y: auto; margin-bottom: 10px; font-size: 13px; color: var(--text-muted);">Cart Empty</div>
                
                <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:700; margin-bottom:15px;">
                    <span>Total</span>
                    <span>KES <span id="pos-total">0</span></span>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <select id="pos-staff-select" class="staff-select" style="flex:1; margin:0;">
                        <option value="">Loading Staff...</option>
                    </select>
                    <button class="btn-header btn-pos" style="flex:1;" onclick="submitPOS()">CHARGE üíµ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="addon-modal" class="modal-overlay">
        <div class="addon-box">
            <h3 id="addon-title" style="margin-top:0;">Customize</h3>
            <div id="addon-options"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-action btn-ready" style="flex:1;" onclick="confirmAddons()">Add Item</button>
                <button class="btn-action btn-done" style="flex:1;" onclick="closeAddons()">Cancel</button>
            </div>
        </div>
    </div>

    <header>
        <div class="brand">
            <h1>Kitchen Display</h1>
            <div class="clock" id="clock">Shift Not Started</div>
        </div>
        <div class="header-controls">
            <button class="btn-header btn-pos" onclick="openPOS()">+ Walk-In Order</button>
            <button class="btn-header" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è Light</button>
            <button class="btn-header" onclick="logout()" style="color:#e74c3c;">Logout</button>
        </div>
    </header>

    <div id="orders-grid">
        <div style="grid-column:1/-1; text-align:center; padding:50px; color:var(--text-muted);">
            Waiting for shift start...
        </div>
    </div>

    <script>
        const PROJECT_URL = "https://uveudhkfncwbllczhbhf.supabase.co";
        const PROJECT_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2ZXVkaGtmbmN3YmxsY3poYmhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NTE5MTksImV4cCI6MjA4MjEyNzkxOX0.30rZbjVgShWxeI5FOD8zGJU-Ho6h6d5s7foEIlQVSZI";
        const db = supabase.createClient(PROJECT_URL, PROJECT_KEY);
        
        let menuItems = []; 
        let posCart = [];
        let staffList = []; 
        let selectedItem = null;
        let selectedAddons = {};
        
        const PLACEHOLDER_IMG = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=';

        const user = JSON.parse(localStorage.getItem('republic_user'));
        if (!user || user.role !== 'barista') window.location.href = 'login.html';

        async function startShift() {
            const audio = document.getElementById('audio-new-order');
            audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(e => console.log(e));
            
            document.getElementById('interaction-overlay').style.display = 'none';
            initRealtime();
            
            await loadStaff();
            loadOrders(); 
            loadMenuForPOS();
            
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('barista_theme', isLight ? 'light' : 'dark');
            document.getElementById('theme-btn').innerText = isLight ? "üåô Dark" : "‚òÄÔ∏è Light";
        }
        if (localStorage.getItem('barista_theme') === 'light') { document.body.classList.add('light-mode'); document.getElementById('theme-btn').innerText = "üåô Dark"; }

        // --- STAFF ---
        async function loadStaff() {
            const { data } = await db.from('users').select('username').in('role', ['barista', 'owner']);
            if (data && data.length > 0) {
                staffList = data.map(u => u.username);
            } else {
                staffList = ['Owner'];
            }
            const posSelect = document.getElementById('pos-staff-select');
            if(posSelect) {
                posSelect.innerHTML = '<option value="">Select Server...</option>' + staffList.map(name => `<option value="${name}">${name}</option>`).join('');
            }
        }

        // --- ORDERS ---
        async function loadOrders() {
            const { data } = await db.from('orders').select('*').neq('status', 'completed').order('created_at', { ascending: true });
            const grid = document.getElementById('orders-grid');
            grid.innerHTML = "";
            if(!data || data.length === 0) { 
                grid.innerHTML = "<div style='grid-column:1/-1; text-align:center; margin-top:50px; color:var(--text-muted);'>No active orders. Kitchen is clear! üßπ</div>"; 
                return; 
            }
            data.forEach(renderCard);
        }

        function renderCard(order) {
            const grid = document.getElementById('orders-grid');
            const card = document.createElement('div');
            card.className = `order-card status-${order.status}`;
            
            const isUnpaid = order.payment_status === 'pending';
            const location = order.order_type === 'dine_in' ? `üìç Table ${order.table_number || '?'}` : `üì¶ Takeaway`;
            
            const itemsHtml = order.items.map(i => `
                <div class="item-row">
                    <span class="item-qty">1x</span> ${i.name}
                    <span class="item-details">${i.details || ''}</span>
                </div>
            `).join('');

            // Staff Dropdown
            let staffHtml = '';
            if (order.handled_by) {
                staffHtml = `<div style="font-size:12px; color:var(--text-muted); margin-bottom:10px;">Server: <b style="color:var(--text-main)">${order.handled_by}</b></div>`;
            } else {
                const options = staffList.map(name => `<option value="${name}">${name}</option>`).join('');
                staffHtml = `<select id="staff-select-${order.id}" class="staff-select"><option value="">Claim Order...</option>${options}</select>`;
            }

            // Buttons
            let btnHtml = '';
            if (isUnpaid) {
                btnHtml = `<button class="btn-action btn-pay" onclick="markPaid(${order.id})">üí∞ Collect Cash</button>`;
            } else {
                if (order.status === 'received') btnHtml = `<button class="btn-action btn-brew" onclick="updateStatus(${order.id}, 'brewing')">Start Brewing ‚òï</button>`;
                else if (order.status === 'brewing') btnHtml = `<button class="btn-action btn-ready" onclick="updateStatus(${order.id}, 'ready')">Mark Ready ‚úÖ</button>`;
                else if (order.status === 'ready') btnHtml = `<button class="btn-action btn-done" onclick="updateStatus(${order.id}, 'completed')">Archive Order üì¶</button>`;
            }

            card.innerHTML = `
                <div class="card-header">
                    <span class="order-id">#${order.id}</span>
                    <span class="order-time">${new Date(order.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                <div style="font-weight:700; margin-bottom:10px; color:var(--text-muted); text-transform:uppercase; font-size:12px;">${location}</div>
                ${staffHtml}
                <div class="order-items">${itemsHtml}</div>
                <div class="card-footer">${btnHtml}</div>
            `;
            grid.appendChild(card);
        }

        async function updateStatus(id, status) {
            const selectEl = document.getElementById(`staff-select-${id}`);
            let handlerName = null;
            if (selectEl) { 
                if (selectEl.value === "") return alert("Please claim this order first!"); 
                handlerName = selectEl.value; 
            }
            
            let updateData = { status: status };
            if (handlerName) updateData.handled_by = handlerName;

            await db.from('orders').update(updateData).eq('id', id); loadOrders(); 
        }

        async function markPaid(id) { if(confirm("Cash received?")) { await db.from('orders').update({ payment_status: 'paid' }).eq('id', id); loadOrders(); } }
        function logout() { localStorage.removeItem('republic_user'); window.location.href = 'login.html'; }

        // --- POS FUNCTIONS ---
        async function loadMenuForPOS() { const { data } = await db.from('menu_items').select('*').eq('is_available', true); menuItems = data; }
        function openPOS() { document.getElementById('pos-modal').style.display = 'flex'; posCart = []; updatePOSDisplay(); renderPOSMenu(); }
        function closePOS() { document.getElementById('pos-modal').style.display = 'none'; }

        function renderPOSMenu() {
            const container = document.getElementById('pos-menu');
            container.innerHTML = menuItems.map(item => {
                const img = item.image_url || PLACEHOLDER_IMG;
                return `
                <div class="pos-item" onclick='clickPOSItem(${JSON.stringify(item)})'>
                    <img src="${img}" class="pos-img">
                    <div class="pos-info">
                        <div style="font-weight:700; font-size:14px;">${item.name}</div>
                        <div style="color:var(--text-muted); font-size:12px;">${item.price}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function clickPOSItem(item) {
            if (item.addons && Array.isArray(item.addons) && item.addons.length > 0) openAddonModal(item);
            else { posCart.push({ id: item.id, name: item.name, price: item.price, details: '' }); updatePOSDisplay(); }
        }

        function openAddonModal(item) {
            selectedItem = item; selectedAddons = {};
            document.getElementById('addon-title').innerText = item.name;
            const container = document.getElementById('addon-options'); container.innerHTML = "";
            
            item.addons.forEach((group) => {
                const groupDiv = document.createElement('div'); 
                groupDiv.innerHTML = `<div style="font-weight:700; margin:10px 0 5px 0;">${group.name}</div>`;
                group.options.forEach((opt) => {
                    const btn = document.createElement('button'); btn.className = 'opt-btn'; 
                    btn.innerText = opt.price > 0 ? `${opt.name} (+${opt.price})` : opt.name;
                    
                    btn.onclick = function() {
                        const isSelected = this.classList.contains('selected');
                        groupDiv.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
                        if (!isSelected) {
                            this.classList.add('selected');
                            selectedAddons[group.name] = { name: opt.name, price: opt.price };
                        } else {
                            delete selectedAddons[group.name];
                        }
                    };
                    groupDiv.appendChild(btn);
                });
                container.appendChild(groupDiv);
            });
            document.getElementById('addon-modal').style.display = 'flex';
        }

        function confirmAddons() {
            let totalAddonPrice = 0; let detailsArr = [];
            Object.keys(selectedAddons).forEach(key => { const opt = selectedAddons[key]; totalAddonPrice += opt.price; detailsArr.push(`${key}: ${opt.name}`); });
            posCart.push({ id: selectedItem.id, name: selectedItem.name, price: selectedItem.price + totalAddonPrice, details: detailsArr.join(', ') });
            closeAddons(); updatePOSDisplay();
        }

        function closeAddons() { document.getElementById('addon-modal').style.display = 'none'; }
        function updatePOSDisplay() {
            const list = document.getElementById('pos-cart-list'); const total = posCart.reduce((sum, item) => sum + item.price, 0);
            if (posCart.length === 0) list.innerHTML = "Cart Empty"; 
            else list.innerHTML = posCart.map(i => `<div style="display:flex; justify-content:space-between; border-bottom:1px solid var(--border); padding:5px 0;"><span>1x ${i.name} <small style="color:var(--text-muted)">${i.details}</small></span><span>${i.price}</span></div>`).join('');
            document.getElementById('pos-total').innerText = total;
        }

        async function submitPOS() {
            if(posCart.length === 0) return alert("Empty order!");
            const handler = document.getElementById('pos-staff-select').value;
            if(!handler) return alert("Select Server!");

            const total = posCart.reduce((sum, item) => sum + item.price, 0);
            const { error } = await db.from('orders').insert([{
                customer_phone: 'Walk-In', items: posCart, total_price: total,
                status: 'received', payment_status: 'paid', payment_method: 'cash', order_type: 'takeaway',
                handled_by: handler
            }]);
            if(error) alert("Error"); else { for (let item of posCart) { await db.rpc('decrease_stock', { item_id: item.id, quantity: 1 }); } closePOS(); loadOrders(); }
        }

        function initRealtime() {
            db.channel('kitchen-feed').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
                loadOrders(); 
                if (payload.eventType === 'INSERT') { const audio = document.getElementById('audio-new-order'); audio.currentTime = 0; audio.play().catch(e => console.log(e)); }
            }).subscribe();
        }
    </script>
</body>
</html>
